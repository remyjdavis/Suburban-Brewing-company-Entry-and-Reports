<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f6f8; }
header {
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:20px;
  padding:14px 20px;
  border-bottom:1px solid #ddd;
  background:#fff;
}
.logo { height:48px; }
section { padding:20px; }
h2 { margin-top:0; }

.card {
  background:#fff;
  border-radius:8px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.card-header {
  font-weight:bold;
  margin-bottom:10px;
}

table { width:100%; border-collapse:collapse; background:#fff; }
th, td { border:1px solid #ddd; padding:8px; }
th { background:#1abc9c; color:#fff; }
select, input { width:100%; padding:6px; }
.quantity-inputs div { margin-bottom:4px; }
.totals { max-width:420px; margin-top:20px; }
.totals div { display:flex; justify-content:space-between; }
.actions button {
  padding:10px 16px;
  margin-right:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.footer-note { margin-top:20px; font-weight:bold; }
.small-btn { padding:6px 12px; margin-top:6px; }
</style>
</head>

<body>

<!-- HEADER -->
<header>
  <img src="../sales/background.jpg" class="logo">

  <div>
    <strong>Suburban Brewing Company</strong><br>
    3041 Horseshoe Pike Suite 120 &amp; 130<br>
    Honey Brook, PA 19344<br>
    Sales Rep: Remy Davis<br>
    Phone: 9086421019<br>
    Email: Remyjdavis90@gmail.com
  </div>

  <div style="text-align:right">
    <strong>Invoice #</strong><br>
    <input id="invoiceNumber" oninput="updateBarcode()">
    <div>Date: <span id="invoiceDate"></span></div>
    <svg id="barcode" style="margin-top:8px;width:160px;height:40px"></svg>
  </div>
</header>

<section>

<!-- CUSTOMER CARD -->
<div class="card">
  <div class="card-header">Customer Information</div>
  <input id="customerName" placeholder="Customer Name">
  <button class="small-btn" onclick="addCustomer()">Set Customer Type</button>
  <div id="customerTypeDisplay" style="margin-top:8px"></div>
</div>

<!-- PRODUCT CARD -->
<div class="card">
  <div class="card-header">Product Management</div>
  <button class="small-btn" onclick="addNewProduct()">âž• Add New Product</button>
</div>

<!-- ITEMS -->
<div class="card">
  <div class="card-header">Invoice Items</div>

  <table id="items">
    <thead>
      <tr>
        <th>Product Name</th>
        <th>Product Type</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><select class="product"></select></td>
        <td>
          <select multiple class="type" onchange="updateQty(this)">
            <option>Case</option>
            <option>Bottle</option>
            <option>1/6 Keg</option>
            <option>1/2 Keg</option>
          </select>
        </td>
        <td><div class="quantity-inputs"></div></td>
        <td><input type="number" class="price" value="0" onchange="recalc()"></td>
        <td class="line-total">$0.00</td>
      </tr>
    </tbody>
  </table>

  <button class="small-btn" onclick="addRow()">Add Item</button>

  <!-- TOTALS -->
  <div class="totals">
    <div><span>Subtotal</span><span>$<span id="subtotal">0.00</span></span></div>
    <div><span>Sales Tax (6%)</span><span>$<span id="tax">0.00</span></span></div>
    <div><span>Discount</span><span>$0.00</span></div>
    <div><span>Keg Deposit</span><span>$<span id="keg">0.00</span></span></div>
    <div><strong>Total</strong><strong>$<span id="grand">0.00</span></strong></div>
  </div>

  <div class="footer-note" id="paymentNote"></div>
</div>

<!-- ACTIONS -->
<div class="card actions">
  <button onclick="savePDF()">Save Invoice</button>
  <button onclick="printPDF()">Print Invoice</button>
  <button onclick="emailInvoice()">Send Invoice via Email</button>
</div>

</section>

<script>
const { jsPDF } = window.jspdf;

/* PRODUCTS */
let products = ["Beer A","Beer B","Beer C"];
function populateProducts(){
  document.querySelectorAll(".product").forEach(sel=>{
    sel.innerHTML="";
    products.forEach(p=>{
      sel.insertAdjacentHTML("beforeend",`<option>${p}</option>`);
    });
  });
}

/* CUSTOMER LOGIC */
let isFintech=false;
let customerType="Restaurant";

function addCustomer(){
  isFintech = confirm("Is this a FINTECH customer?");
  const isRestaurant = confirm("Is this customer a RESTAURANT?");
  customerType = isRestaurant ? "Restaurant":"Wholesaler";

  customerTypeDisplay.innerHTML =
    `Payment: ${isFintech?"Fintech":"Check"}<br>
     Type: ${customerType}`;

  paymentNote.textContent =
    isFintech
      ? "Paid through Fintech"
      : "Make checks payable to Suburban Brewing Company";

  recalc();
}

/* INIT */
invoiceDate.textContent = new Date().toLocaleDateString();
invoiceNumber.value = "INV-" + Math.floor(Math.random()*900000);
populateProducts();
updateBarcode();

/* BARCODE */
function updateBarcode(){
  JsBarcode("#barcode", invoiceNumber.value,{displayValue:false});
}

/* PRODUCT CREATE */
function addNewProduct(){
  const name = prompt("Enter new product name:");
  if(!name || products.includes(name)) return;
  products.push(name);
  populateProducts();
}

/* ROWS */
function addRow(){
  const tbody=document.querySelector("#items tbody");
  const clone=tbody.rows[0].cloneNode(true);
  clone.querySelector(".quantity-inputs").innerHTML="";
  clone.querySelector(".price").value=0;
  clone.querySelector(".line-total").textContent="$0.00";
  tbody.appendChild(clone);
  populateProducts();
}

/* QUANTITY */
function updateQty(sel){
  const box=sel.closest("tr").querySelector(".quantity-inputs");
  box.innerHTML="";
  [...sel.selectedOptions].forEach(o=>{
    box.insertAdjacentHTML("beforeend",
      `<div>${o.textContent}: <input type="number" value="1" onchange="recalc()"></div>`
    );
  });
  recalc();
}

/* CALC */
function recalc(){
  let subtotal=0,keg=0;
  document.querySelectorAll("#items tbody tr").forEach(r=>{
    let row=0;
    const price=+r.querySelector(".price").value||0;
    const qtys=r.querySelectorAll(".quantity-inputs input");
    const types=r.querySelectorAll(".type option:checked");

    types.forEach((t,i)=>{
      const q=+qtys[i]?.value||0;
      row+=q*price;
      if(t.textContent.includes("Keg")) keg+=30;
    });

    r.querySelector(".line-total").textContent="$"+row.toFixed(2);
    subtotal+=row;
  });

  const tax=customerType==="Restaurant"?subtotal*0.06:0;
  subtotalElem.textContent=subtotal.toFixed(2);
  taxElem.textContent=tax.toFixed(2);
  kegElem.textContent=keg.toFixed(2);
  grandElem.textContent=(subtotal+tax+keg).toFixed(2);
}

/* PDF */
function buildPDF(){
  const doc=new jsPDF();
  doc.text("Suburban Brewing Company",15,15);
  doc.text("Invoice #: "+invoiceNumber.value,150,15);
  doc.text("Date: "+invoiceDate.textContent,150,22);

  const bc=document.createElement("canvas");
  JsBarcode(bc,invoiceNumber.value,{displayValue:false});
  doc.addImage(bc,"PNG",150,28,40,14);

  const rows=[];
  document.querySelectorAll("#items tbody tr").forEach(r=>{
    const name=r.querySelector(".product").value;
    const price=r.querySelector(".price").value;
    const qtys=r.querySelectorAll(".quantity-inputs input");
    const types=r.querySelectorAll(".type option:checked");
    types.forEach((t,i)=>{
      rows.push([name,t.textContent,qtys[i]?.value||0,"$"+price,r.querySelector(".line-total").textContent]);
    });
  });

  doc.autoTable({startY:50,head:[["Product","Type","Qty","Price","Total"]],body:rows});

  let y=doc.lastAutoTable.finalY+10;
  doc.text("Subtotal: $"+subtotal.textContent,150,y);
  doc.text("Tax: $"+tax.textContent,150,y+6);
  doc.text("Keg Deposit: $"+keg.textContent,150,y+12);
  doc.text("Total: $"+grand.textContent,150,y+18);
  doc.text(paymentNote.textContent,15,y+32);

  return doc;
}

function savePDF(){buildPDF().save(invoiceNumber.value+".pdf");}
function printPDF(){const d=buildPDF();d.autoPrint();window.open(d.output("bloburl"));}
function emailInvoice(){window.location.href=`mailto:?subject=Invoice ${invoiceNumber.value}&body=Total $${grand.textContent}`;}
</script>

</body>
</html>
