<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px }
.container { background:#fff; padding:20px; max-width:1100px; margin:auto }
header { display:flex; justify-content:space-between }
.hidden { display:none }
.card {
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:flex; align-items:center; justify-content:center;
}
.card-inner {
  background:#fff; padding:20px; width:400px;
}
</style>
</head>

<body>
<div class="container">

<header>
  <div>
    <strong>Suburban Brewing Company</strong><br>
    3041 Horseshoe Pike Suite 120 & 130<br>
    Honey Brook, PA 19344
  </div>
  <div>
    Invoice #: <input id="invoiceNumber" value="INV-1001"><br>
    Date: <span id="invoiceDate"></span><br>
    <svg id="barcode"></svg>
  </div>
</header>

<hr>

<h3>Customer</h3>
<input id="customerName" placeholder="Customer Name">
<input id="customerAddress" placeholder="Customer Address">

<h3>Invoice Items</h3>
<table id="itemsTable" border="1" width="100%">
<thead>
<tr>
  <th>Product</th>
  <th>Type</th>
  <th>Qty</th>
  <th>Price</th>
  <th>Total</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="addRow()">Add Item</button>

<h3>Totals</h3>
<div>Subtotal: $<span id="sub">0.00</span></div>
<div>Discount: $<span id="disc">0.00</span></div>
<div>Sales Tax: $<span id="tax">0.00</span></div>
<div>Keg Deposit: $<span id="keg">0.00</span></div>
<h2>Total: $<span id="total">0.00</span></h2>

<button onclick="submitInvoice()">Submit Invoice</button>

</div>

<!-- CUSTOMER CARD -->
<div id="customerCard" class="card hidden">
  <div class="card-inner">
    <h3>New Customer</h3>
    <select id="custType">
      <option value="restaurant">Restaurant</option>
      <option value="wholesaler">Wholesaler</option>
    </select>
    <select id="custPayment">
      <option value="check">Check</option>
      <option value="fintech">Fintech</option>
    </select>
    <button onclick="confirmCustomer()">Save</button>
  </div>
</div>

<!-- PRODUCT CARD -->
<div id="productCard" class="card hidden">
  <div class="card-inner">
    <h3>New Product</h3>
    <select id="prodType">
      <option>Case</option>
      <option>1/6 Keg</option>
      <option>1/2 Keg</option>
    </select>
    <input id="prodPrice" type="number" placeholder="Default Price">
    <button onclick="confirmProduct()">Save</button>
  </div>
</div>

<script>
const API_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

let customers = {};
let products = {};
let pendingProduct = null;

document.getElementById("invoiceDate").innerText =
  new Date().toLocaleDateString();

JsBarcode("#barcode", invoiceNumber.value, { displayValue:false });

function addRow() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input onblur="checkProduct(this)"></td>
    <td>
      <select onchange="calc()">
        <option>Case</option>
        <option>1/6 Keg</option>
        <option>1/2 Keg</option>
      </select>
    </td>
    <td><input type="number" value="1" oninput="calc()"></td>
    <td><input type="number" value="0" oninput="calc()"></td>
    <td>$0.00</td>
  `;
  document.querySelector("#itemsTable tbody").append(tr);
}

function checkProduct(input) {
  if (!products[input.value]) {
    pendingProduct = input.value;
    document.getElementById("productCard").classList.remove("hidden");
  }
}

function confirmProduct() {
  products[pendingProduct] = {
    type: prodType.value,
    price: prodPrice.value
  };
  document.getElementById("productCard").classList.add("hidden");
}

function calc() {
  let sub=0, cases=0, kegs=0;
  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
    const type=r.children[1].firstChild.value;
    const qty=+r.children[2].firstChild.value;
    const price=+r.children[3].firstChild.value;
    const line=qty*price;
    r.children[4].innerText="$"+line.toFixed(2);
    sub+=line;
    if(type==="Case") cases+=qty;
    if(type.includes("Keg")) kegs+=qty;
  });
  let disc = cases>10 ? sub*0.10 : 0;
  let tax = custType?.value==="restaurant" ? (sub-disc)*0.06 : 0;
  let keg = kegs*30;
  subSpan=sub;
  document.getElementById("sub").innerText=sub.toFixed(2);
  document.getElementById("disc").innerText=disc.toFixed(2);
  document.getElementById("tax").innerText=tax.toFixed(2);
  document.getElementById("keg").innerText=keg.toFixed(2);
  document.getElementById("total").innerText=(sub-disc+tax+keg).toFixed(2);
}

function submitInvoice() {
  if (!customers[customerName.value]) {
    document.getElementById("customerCard").classList.remove("hidden");
    return;
  }
  send();
}

function confirmCustomer() {
  customers[customerName.value]={
    type:custType.value,
    payment:custPayment.value
  };
  document.getElementById("customerCard").classList.add("hidden");
  send();
}

function send() {
  const items=[];
  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
    items.push({
      product:r.children[0].firstChild.value,
      type:r.children[1].firstChild.value,
      quantity:+r.children[2].firstChild.value,
      unitPrice:+r.children[3].firstChild.value,
      lineTotal:parseFloat(r.children[4].innerText.replace("$",""))
    });
  });

  const payload={
    invoiceNumber:invoiceNumber.value,
    date:new Date().toISOString().slice(0,10),
    customer:{
      name:customerName.value,
      address:customerAddress.value,
      type:custType.value,
      payment:custPayment.value
    },
    items,
    subtotal:+sub.innerText,
    discount:+disc.innerText,
    tax:+tax.innerText,
    kegDeposit:+keg.innerText,
    total:+total.innerText,
    status:"final",
    pdfBase64:""
  };

  fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
}
</script>
</body>
</html>
