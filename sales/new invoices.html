<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px }
.container { background:#fff; padding:20px; max-width:1100px; margin:auto }
header { display:flex; justify-content:space-between }
.company { display:flex; gap:15px }
.company img { width:80px }
table { width:100%; border-collapse:collapse; margin-top:15px }
th,td { border:1px solid #ccc; padding:8px }
th { background:#18b89a; color:#fff }
input,select { width:100%; padding:6px }
button { padding:8px 14px; margin:6px 4px }
.totals { max-width:320px; margin-left:auto }
.totals div { display:flex; justify-content:space-between; margin:6px 0 }
</style>
</head>

<body>
<div class="container">

<header>
  <div class="company">
    <img src="background.jpg">
    <div>
      <strong>Suburban Brewing Company</strong><br>
      3041 Horseshoe Pike Suite 120 & 130<br>
      Honey Brook, PA 19344<br>
      Sales Rep: Remy Davis | 908-642-1019<br>
      Remyjdavis90@gmail.com
    </div>
  </div>
  <div>
    Invoice # <input id="invoiceNumber" oninput="refreshBarcode()"><br>
    Date: <span id="invoiceDate"></span><br>
    <canvas id="barcodeCanvas"></canvas>
  </div>
</header>

<hr>

<h3>Customer</h3>
<input id="customerName" list="customerList" autocomplete="off"
       oninput="handleCustomerInput(this.value)">
<div id="customerAddress" style="margin-top:6px;font-style:italic;"></div>
<datalist id="customerList"></datalist>

<h3>Invoice Items</h3>

<table id="itemsTable">
<thead>
<tr>
  <th>Product</th>
  <th>Type</th>
  <th>Qty</th>
  <th>Unit Price</th>
  <th>Total</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="addRow()">Add Item</button>

<div class="totals">
  <div><span>Subtotal</span><span id="sub">$0.00</span></div>
  <div><span>Discount</span><span id="disc">$0.00</span></div>
  <div><span>Sales Tax</span><span id="tax">$0.00</span></div>
  <div><span>Keg Deposit</span><span id="keg">$0.00</span></div>
  <hr>
  <div><strong>Total</strong><strong id="total">$0.00</strong></div>
</div>

<button onclick="printInvoice()">Print</button>
<button onclick="saveInvoice()">Save</button>
<button onclick="emailInvoice()">Email</button>
<button onclick="goBack()">Back</button>

<p id="paymentNote">Make checks payable to Suburban Brewing Company.</p>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbys580shBiRLtAW0jAYFoinwKJrycSJQyW8qy95nvLr7dxqOGtzI3e_h9QQn8-ULTT3/exec";
const TYPES = ["Case","Bottle","1/6 Keg","1/2 Keg"];
const SALES_TAX_RATE = 0.06;
const KEG_DEPOSIT = 30;

let customers=[], selectedCustomer=null;

invoiceDate.innerText = new Date().toLocaleDateString();
invoiceNumber.value = "INV-" + Date.now();
refreshBarcode();

/* LOAD CUSTOMERS */
fetch(API+"?action=getCustomers")
  .then(r=>r.json())
  .then(d=>{
    customers=d;
    customerList.innerHTML=d.map(c=>`<option value="${c.name}">`).join("");
  });

function handleCustomerInput(val){
  const c = customers.find(x=>x.name.toLowerCase()===val.toLowerCase());
  if(c){
    selectedCustomer=c;
    customerAddress.innerText=c.address;
  } else {
    selectedCustomer=null;
    customerAddress.innerText="";
  }
}

/* ---------- TOTALS ---------- */
function calc(){
  let subtotal=0,cases=0,kegs=0;
  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
    const price=+r.children[3].firstChild.value;
    let qty=0;
    r.children[2].querySelectorAll("input").forEach(i=>{
      qty+=+i.value;
      if(i.dataset.type==="Case") cases+=+i.value;
      if(i.dataset.type.includes("Keg")) kegs+=+i.value;
    });
    const line=price*qty;
    r.children[4].innerText="$"+line.toFixed(2);
    subtotal+=line;
  });

  const discount = cases>10 ? subtotal*0.10 : 0;
  const tax = selectedCustomer?.type==="Restaurant" ? subtotal*SALES_TAX_RATE : 0;
  const deposit = kegs*KEG_DEPOSIT;

  sub.innerText="$"+subtotal.toFixed(2);
  disc.innerText="$"+discount.toFixed(2);
  tax.innerText="$"+tax.toFixed(2);
  keg.innerText="$"+deposit.toFixed(2);
  total.innerText="$"+(subtotal-discount+tax+deposit).toFixed(2);
}
</script>

<!-- ========================================================= -->
<!-- ===================== ADDITIONS ONLY ==================== -->
<!-- ========================================================= -->

<script>
/* === ADDITION: SAFE BARCODE FUNCTION (NO EXISTING CODE TOUCHED) === */
function refreshBarcode(){
  try{
    JsBarcode("#barcodeCanvas", document.getElementById("invoiceNumber").value || "", {
      displayValue:false
    });
  }catch(e){}
}
/* ================================================================ */
</script>

<script>
/* === ADDITION: PRODUCT AUTOCOMPLETE DATALIST (ADD-ONLY) === */
const productDatalist=document.createElement("datalist");
productDatalist.id="productList";
document.body.appendChild(productDatalist);

fetch(API+"?action=getProducts")
  .then(r=>r.json())
  .then(list=>{
    list.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.product;
      productDatalist.appendChild(o);
    });
  });

const _addRow=addRow;
addRow=function(){
  _addRow();
  const i=document.querySelector("#itemsTable tbody tr:last-child input");
  if(i) i.setAttribute("list","productList");
};
/* ============================================================ */
</script>

<script>
/* === ADDITION: BACK BUTTON TARGET FIX === */
function goBack(){
  window.location.href="invoices.html";
}
/* ===================================== */
</script>
<!-- ========================================================= -->
<!-- =============== BACKEND WIRING (ADD ONLY) =============== -->
<!-- ========================================================= -->

<script>
/* ===================== BACKEND CONSTANT ===================== */
const BACKEND_API = "https://script.google.com/macros/s/AKfycbys580shBiRLtAW0jAYFoinwKJrycSJQyW8qy95nvLr7dxqOGtzI3e_h9QQn8-ULTT3/exec";
/* ============================================================ */


/* ===================== SAVE NEW CUSTOMER ===================== */
/* Wrap existing confirmCustomer() WITHOUT touching it */
if (typeof confirmCustomer === "function") {
  const __confirmCustomer = confirmCustomer;
  confirmCustomer = function () {
    const name = mcName.value.trim();
    const address = mcAddress.value.trim();
    const type = mcType.value;
    const payment = mcPayment.value;

    fetch(
      BACKEND_API +
        "?action=saveCustomer" +
        "&name=" + encodeURIComponent(name) +
        "&address=" + encodeURIComponent(address) +
        "&type=" + encodeURIComponent(type) +
        "&payment=" + encodeURIComponent(payment)
    )
      .then(r => r.json())
      .then(() => {
        __confirmCustomer(); // preserve existing behavior
      });
  };
}
/* ============================================================ */


/* ===================== SAVE NEW PRODUCT ===================== */
/* Supports MULTI-TYPE + MULTI-PRICE */
if (typeof confirmProduct === "function") {
  const __confirmProduct = confirmProduct;
  confirmProduct = function () {
    const productName = mpName.value.trim();

    document.querySelectorAll("#productTypes input").forEach(row => {
      const type = row.dataset.type;
      const price = parseFloat(row.value || 0);

      fetch(
        BACKEND_API +
          "?action=saveProduct" +
          "&product=" + encodeURIComponent(productName) +
          "&type=" + encodeURIComponent(type) +
          "&price=" + encodeURIComponent(price)
      );
    });

    __confirmProduct(); // keep existing UI logic
  };
}
/* ============================================================ */


/* ===================== SAVE INVOICE ===================== */
/* Wrap existing saveInvoice() */
if (typeof saveInvoice === "function") {
  const __saveInvoice = saveInvoice;

  saveInvoice = function () {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    pdf.text("Invoice " + invoiceNumber.value, 14, 14);
    pdf.autoTable({ html: "#itemsTable" });

    const pdfBase64 = btoa(
      new Uint8Array(pdf.output("arraybuffer"))
        .reduce((d, b) => d + String.fromCharCode(b), "")
    );

    let subtotal = parseFloat(sub.innerText.replace("$", ""));
    let discount = parseFloat(disc.innerText.replace("$", ""));
    let tax = parseFloat(taxEl.innerText.replace("$", ""));
    let deposit = parseFloat(keg.innerText.replace("$", ""));
    let totalVal = parseFloat(total.innerText.replace("$", ""));

    let totalCases = 0;
    let totalKegs = 0;

    document.querySelectorAll("#itemsTable tbody tr").forEach(r => {
      r.children[2].querySelectorAll("input").forEach(i => {
        if (i.dataset.type === "Case") totalCases += +i.value;
        if (i.dataset.type.includes("Keg")) totalKegs += +i.value;
      });
    });

    const payload = {
      invoice: invoiceNumber.value,
      customer: customerName.value,
      customerType: selectedCustomer?.type || "",
      subtotal,
      totalCases,
      kegs: totalKegs,
      pdfBase64
    };

    fetch(BACKEND_API, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "action=saveInvoice&payload=" + encodeURIComponent(JSON.stringify(payload))
    })
      .then(r => r.json())
      .then(() => {
        __saveInvoice(); // preserve any existing behavior
        alert("Invoice saved to Sheets and Drive");
      });
  };
}
/* ============================================================ */


/* ===================== SAVE LINE ITEMS ===================== */
/* Additive â€“ no UI change */
function saveInvoiceLineItems(invoiceNumberValue) {
  document.querySelectorAll("#itemsTable tbody tr").forEach(r => {
    const product = r.children[0].querySelector("input").value;
    const price = r.children[3].querySelector("input").value;

    r.children[2].querySelectorAll("input").forEach(i => {
      fetch(
        BACKEND_API +
          "?action=saveInvoiceItem" +
          "&invoice=" + encodeURIComponent(invoiceNumberValue) +
          "&product=" + encodeURIComponent(product) +
          "&type=" + encodeURIComponent(i.dataset.type) +
          "&qty=" + encodeURIComponent(i.value) +
          "&price=" + encodeURIComponent(price)
      );
    });
  });
}
/* ============================================================ */
</script>
<script>
/* ========================================================= */
/* ========== ADDITION: GUARANTEED CUSTOMER SAVE ============ */
/* ========================================================= */

(function(){
  let __customerSaved = false;

  function saveCustomerToBackend(customer){
    if(__customerSaved) return;
    __customerSaved = true;

    fetch(
      API +
      "?action=saveCustomer" +
      "&name=" + encodeURIComponent(customer.name) +
      "&address=" + encodeURIComponent(customer.address || "") +
      "&type=" + encodeURIComponent(customer.type || "") +
      "&payment=" + encodeURIComponent(customer.payment || "")
    ).then(()=> {
      console.log("Customer saved to Sheets:", customer.name);
    });
  }

  /* Hook into EXISTING customer selection */
  const __handleCustomerInput = handleCustomerInput;
  handleCustomerInput = function(val){
    __handleCustomerInput(val);

    if(selectedCustomer && selectedCustomer.__isNew){
      saveCustomerToBackend(selectedCustomer);
    }
  };

  /* Hook into modal confirm if it exists */
  if(typeof confirmCustomer === "function"){
    const __confirmCustomer = confirmCustomer;
    confirmCustomer = function(){
      __confirmCustomer();

      if(window.selectedCustomer){
        saveCustomerToBackend(selectedCustomer);
      }
    };
  }
})();
</script>
<script>
function postSaveCustomer(customer){
  return fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "saveCustomer",
      name: customer.name,
      address: customer.address || "",
      type: customer.type || "",
      payment: customer.payment || ""
    })
  }).then(r => r.json());
}
</script>
<script>
/* =========================================================
   FINAL CUSTOMER SAVE OVERRIDE (LOCKED)
   Forces POST + JSON
========================================================= */

(function(){
  const _handleCustomerInput = handleCustomerInput;

  handleCustomerInput = function(val){
    _handleCustomerInput(val);

    if (!selectedCustomer) return;
    if (selectedCustomer.__saved) show;

    selectedCustomer.__saved = true;

    fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "saveCustomer",
        name: selectedCustomer.name,
        address: selectedCustomer.address || "",
        type: selectedCustomer.type || "",
        payment: selectedCustomer.payment || ""
      })
    }).then(()=>console.log("Customer POST saved"));
  };
})();
</script>
<script>
/* =========================================================
   FINAL INVOICE SAVE OVERRIDE (LOCKED)
========================================================= */

(function(){
  const _saveInvoice = saveInvoice;

  saveInvoice = function(){
    const pdf = buildPDF();

    const pdfBase64 = btoa(
      new Uint8Array(pdf.output("arraybuffer"))
        .reduce((d,b)=>d+String.fromCharCode(b),"")
    );

    let subtotal = parseFloat(sub.innerText.replace("$",""));
    let totalCases = 0;
    let totalKegs = 0;

    document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
      r.children[2].querySelectorAll("input").forEach(i=>{
        if(i.dataset.type==="Case") totalCases+=+i.value;
        if(i.dataset.type.includes("Keg")) totalKegs+=+i.value;
      });
    });

    fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "saveInvoice",
        invoice: invoiceNumber.value,
        customer: customerName.value,
        customerType: selectedCustomer?.type || "",
        subtotal,
        totalCases,
        kegs: totalKegs,
        pdfBase64
      })
    })
    .then(r=>r.json())
    .then(()=>{
      alert("Invoice saved to Sheets & Drive");
      _saveInvoice(); // preserve UI behavior
    });
  };
})();
</script>

</body>
</html>
