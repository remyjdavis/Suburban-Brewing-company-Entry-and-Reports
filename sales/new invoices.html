<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
header {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #ddd;
  padding: 10px 20px;
}
.logo { height: 40px; margin-right: 12px; }
section { padding: 20px; }
h2 { margin-top: 0; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ddd; padding: 8px; }
th { background: #1abc9c; color: white; }
select, input { width: 100%; }
.quantity-inputs div { margin-bottom: 4px; }
.totals { max-width: 400px; margin-top: 20px; }
.totals div { display: flex; justify-content: space-between; }
.actions { margin-top: 20px; }
</style>
</head>

<body>

<!-- HEADER -->
<header>
  <img src="../sales/background.jpg" class="logo">
  <div>
    <strong>Suburban Brewing Company</strong><br>
    3041 Horseshoe Pike Suite 120 & 130<br>
    Honey Brook, PA 19344<br>
    Sales Rep: Remy Davis | Phone: 9086421019<br>
    Email: Remyjdavis90@gmail.com
  </div>
  <div style="margin-left:auto;text-align:right">
    <div><strong>Invoice #</strong></div>
    <input id="invoiceNumber" readonly>
    <div id="invoiceDate"></div>
    <svg id="barcode"></svg>
  </div>
</header>

<!-- CUSTOMER -->
<section>
  <h2>Search for Customer</h2>
  <input placeholder="Enter customer name or email">
</section>

<!-- ITEMS -->
<section>
  <h2>Invoice Items</h2>
  <table id="invoiceItemsTable">
    <thead>
      <tr>
        <th>Product Name</th>
        <th>Product Type</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <select class="product-name">
            <option>Beer A</option>
            <option>Beer B</option>
            <option>Beer C</option>
          </select>
        </td>
        <td>
          <select multiple class="product-type" onchange="updateQuantities(this)">
            <option>Case</option>
            <option>Bottle</option>
            <option>1/6 Keg</option>
            <option>1/2 Keg</option>
          </select>
        </td>
        <td class="quantity-cell">
          <div class="quantity-inputs"></div>
        </td>
        <td>
          <input type="number" class="unit-price" value="0" onchange="recalc()">
        </td>
        <td class="line-total">$0.00</td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">Add Item</button>

  <!-- TOTALS (VISIBLE ON PAGE) -->
  <div class="totals">
    <div><span>Subtotal</span><span>$<span id="subtotal">0.00</span></span></div>
    <div><span>Sales Tax (6%)</span><span>$<span id="tax">0.00</span></span></div>
    <div><span>Discount</span><span>$<span id="discount">0.00</span></span></div>
    <div><span>Keg Deposit</span><span>$<span id="keg">0.00</span></span></div>
    <div><strong>Total</strong><strong>$<span id="finalTotal">0.00</span></strong></div>
  </div>
</section>

<!-- ACTIONS -->
<section class="actions">
  <button onclick="savePDF()">Save Invoice</button>
  <button onclick="printPDF()">Print Invoice</button>
</section>

<script>
const { jsPDF } = window.jspdf;
const customerType = "Restaurant";

/* INIT */
const inv = "INV-" + Math.floor(Math.random()*1000000);
invoiceNumber.value = inv;
invoiceDate.textContent = new Date().toLocaleDateString();
JsBarcode("#barcode", inv, { displayValue:false });

/* DYNAMIC QUANTITIES */
function updateQuantities(sel) {
  const cell = sel.closest("tr").querySelector(".quantity-inputs");
  cell.innerHTML = "";
  Array.from(sel.selectedOptions).forEach(o=>{
    cell.insertAdjacentHTML("beforeend",
      `${o.textContent}: <input type="number" value="1" onchange="recalc()">`
    );
  });
  recalc();
}

/* ADD ROW */
function addRow() {
  const tbody=document.querySelector("#invoiceItemsTable tbody");
  tbody.insertAdjacentHTML("beforeend", tbody.rows[0].outerHTML);
}

/* CALCULATIONS */
function recalc() {
  let subtotal=0, keg=0;

  document.querySelectorAll("tbody tr").forEach(r=>{
    const price=+r.querySelector(".unit-price").value||0;
    let rowTotal=0;

    r.querySelectorAll(".quantity-inputs input").forEach(i=>{
      rowTotal+=price*(+i.value||0);
    });

    if ([...r.querySelectorAll(".product-type option:checked")]
        .some(o=>o.textContent.includes("Keg"))) keg+=30;

    r.querySelector(".line-total").textContent="$"+rowTotal.toFixed(2);
    subtotal+=rowTotal;
  });

  const tax = customerType==="Restaurant" ? subtotal*0.06 : 0;

  subtotalEl.textContent=subtotal.toFixed(2);
  taxEl.textContent=tax.toFixed(2);
  discount.textContent="0.00";
  kegEl.textContent=keg.toFixed(2);
  finalTotal.textContent=(subtotal+tax+keg).toFixed(2);
}

const subtotalEl=subtotal, taxEl=tax, kegEl=keg;

/* PDF */
function buildPDF() {
  const doc=new jsPDF();
  const logo=document.querySelector(".logo");

  doc.addImage(logo,"JPEG",15,10,30,30);
  doc.text("Suburban Brewing Company",50,15);
  doc.text(`Invoice #: ${inv}`,150,15);
  doc.text(`Date: ${invoiceDate.textContent}`,150,22);

  const bc=document.createElement("canvas");
  JsBarcode(bc,inv,{displayValue:false});
  doc.addImage(bc,"PNG",150,30,45,14);

  const rows=[];
  document.querySelectorAll("tbody tr").forEach(r=>{
    const name=r.querySelector(".product-name").value;
    const price=r.querySelector(".unit-price").value;
    const qtyInputs=r.querySelectorAll(".quantity-inputs input");
    const types=r.querySelectorAll(".product-type option:checked");

    types.forEach((t,i)=>{
      rows.push([
        name,
        t.textContent,
        qtyInputs[i]?.value||0,
        price,
        r.querySelector(".line-total").textContent
      ]);
    });
  });

  doc.autoTable({
    startY:55,
    head:[["Product","Type","Qty","Price","Total"]],
    body:rows
  });

  let y=doc.lastAutoTable.finalY+10;
  doc.text(`Subtotal: $${subtotal.textContent}`,150,y);
  doc.text(`Tax: $${tax.textContent}`,150,y+6);
  doc.text(`Keg Deposit: $${keg.textContent}`,150,y+12);
  doc.text(`Total: $${finalTotal.textContent}`,150,y+18);

  doc.text(
    customerType==="Restaurant"
      ?"Make checks payable to Suburban Brewing Company."
      :"Paid through Fintech.",
    15,y+35
  );

  return doc;
}

function savePDF(){ buildPDF().save(inv+".pdf"); }
function printPDF(){
  const p=buildPDF();
  p.autoPrint();
  window.open(p.output("bloburl"));
}
</script>

</body>
</html>
