<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px }
.container { background:#fff; padding:20px; max-width:1100px; margin:auto }
table { width:100%; border-collapse:collapse; margin-top:15px }
th,td { border:1px solid #ccc; padding:8px }
th { background:#18b89a; color:#fff }
input,select { width:100%; padding:6px }
button { padding:8px 14px; margin-top:10px }

.modal {
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-content {
  background:#fff;
  padding:20px;
  width:400px;
}
</style>
</head>

<body>
<div class="container">

<h2>Invoice Items</h2>

<table id="itemsTable">
<thead>
<tr>
  <th>Product</th>
  <th>Type</th>
  <th>Qty</th>
  <th>Unit Price</th>
  <th>Total</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="addRow()">Add Item</button>

</div>

<!-- NEW PRODUCT MODAL -->
<div class="modal" id="newProductModal">
  <div class="modal-content">
    <h3>New Product</h3>

    <div>
      <strong>Product Name</strong>
      <input id="np_name">
    </div>

    <div>
      <strong>Product Types & Prices</strong>
      <div>
        <label><input type="checkbox" value="Case"> Case</label>
        <input type="number" data-price="Case" placeholder="Price">
      </div>
      <div>
        <label><input type="checkbox" value="Bottle"> Bottle</label>
        <input type="number" data-price="Bottle" placeholder="Price">
      </div>
      <div>
        <label><input type="checkbox" value="1/6 Keg"> 1/6 Keg</label>
        <input type="number" data-price="1/6 Keg" placeholder="Price">
      </div>
      <div>
        <label><input type="checkbox" value="1/2 Keg"> 1/2 Keg</label>
        <input type="number" data-price="1/2 Keg" placeholder="Price">
      </div>
    </div>

    <button onclick="saveNewProduct()">Save Product</button>
    <button onclick="closeNewProduct()">Cancel</button>
  </div>
</div>

<script>
/*************************************************
 * CONFIG
 *************************************************/
const API_URL = "https://script.google.com/macros/s/AKfycbys580shBiRLtAW0jAYFoinwKJrycSJQyW8qy95nvLr7dxqOGtzI3e_h9QQn8-ULTT3/exec";
const PRODUCT_TYPES = ["Case","Bottle","1/6 Keg","1/2 Keg"];

let productsCache = [];
let pendingProductInput = null;

/*************************************************
 * LOAD PRODUCTS
 *************************************************/
fetch(`${API_URL}?action=getProducts`)
  .then(r=>r.json())
  .then(d=>productsCache = d);

/*************************************************
 * TABLE LOGIC
 *************************************************/
function addRow(){
  const tr = document.createElement("tr");

  const name = document.createElement("input");
  name.onblur = () => checkNewProduct(name);

  const type = document.createElement("select");
  type.multiple = true;
  PRODUCT_TYPES.forEach(t=>type.add(new Option(t,t)));

  const qty = document.createElement("div");
  type.onchange = () => buildQty(qty, type);

  const price = document.createElement("input");
  price.type="number";
  price.oninput = calc;

  const total = document.createElement("span");
  total.innerText = "$0.00";

  tr.append(td(name), td(type), td(qty), td(price), td(total));
  document.querySelector("#itemsTable tbody").append(tr);
}

function buildQty(container, select){
  container.innerHTML="";
  [...select.selectedOptions].forEach(o=>{
    const i=document.createElement("input");
    i.type="number";
    i.value=1;
    i.dataset.type=o.value;
    i.oninput=calc;
    container.append(o.value+" ", i, document.createElement("br"));
  });
}

function td(el){
  const td=document.createElement("td");
  td.append(el);
  return td;
}

function calc(){
  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
    const price=+r.children[3].firstChild.value;
    let qty=0;
    r.children[2].querySelectorAll("input").forEach(i=>qty+=+i.value);
    r.children[4].innerText="$"+(price*qty).toFixed(2);
  });
}

/*************************************************
 * NEW PRODUCT LOGIC
 *************************************************/
function checkNewProduct(input){
  const val = input.value.trim();
  if(!val) return;

  const exists = productsCache.some(p=>p.product === val);
  if(!exists){
    pendingProductInput = input;
    document.getElementById("np_name").value = val;
    document.getElementById("newProductModal").style.display="flex";
  }
}

function closeNewProduct(){
  document.getElementById("newProductModal").style.display="none";
}

function saveNewProduct(){
  const name = document.getElementById("np_name").value;

  document.querySelectorAll("#newProductModal input[type=checkbox]:checked")
    .forEach(cb=>{
      const price = document.querySelector(`[data-price="${cb.value}"]`).value;

      fetch(`${API_URL}?action=saveProduct&product=${encodeURIComponent(name)}&type=${encodeURIComponent(cb.value)}&price=${price}`);
      productsCache.push({ product:name, type:cb.value, price:price });
    });

  closeNewProduct();
}
</script>
</body>
</html>
