<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 0; }
header {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #ddd;
  padding: 12px 20px;
}
.logo { height: 42px; margin-right: 14px; }
section { padding: 20px; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ddd; padding: 8px; }
th { background: #1abc9c; color: #fff; }
select, input { width: 100%; }
.quantity-inputs div { margin-bottom: 4px; }
.totals { max-width: 420px; margin-top: 20px; }
.totals div {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
}
.actions button { margin-right: 10px; }
</style>
</head>

<body>

<!-- HEADER -->
<header>
  <img src="../sales/background.jpg" class="logo">
  <div>
    <strong>Suburban Brewing Company</strong><br>
    3041 Horseshoe Pike Suite 120 & 130<br>
    Honey Brook, PA 19344<br>
    Sales Rep: Remy Davis | Phone: 9086421019<br>
    Email: Remyjdavis90@gmail.com
  </div>

  <div style="margin-left:auto;text-align:right">
    <div><strong>Invoice #</strong></div>
    <input id="invoiceNumber" readonly>
    <div id="invoiceDate"></div>
    <svg id="barcode" style="margin-top:6px"></svg>
  </div>
</header>

<!-- CUSTOMER -->
<section>
  <h3>Search for Customer</h3>
  <input placeholder="Enter customer name or email">
</section>

<!-- ITEMS -->
<section>
<h3>Invoice Items</h3>

<table id="items">
<thead>
<tr>
  <th>Product Name</th>
  <th>Product Type</th>
  <th>Quantity</th>
  <th>Unit Price</th>
  <th>Total</th>
</tr>
</thead>

<tbody>
<tr>
<td>
  <select class="product">
    <option>Beer A</option>
    <option>Beer B</option>
    <option>Beer C</option>
  </select>
</td>

<td>
  <select multiple class="type" onchange="updateQty(this)">
    <option>Case</option>
    <option>Bottle</option>
    <option>1/6 Keg</option>
    <option>1/2 Keg</option>
  </select>
</td>

<td class="qty-cell">
  <div class="quantity-inputs"></div>
</td>

<td>
  <input type="number" class="price" value="0" onchange="recalc()">
</td>

<td class="line-total">$0.00</td>
</tr>
</tbody>
</table>

<button onclick="addRow()">Add Item</button>

<!-- TOTALS -->
<div class="totals">
  <div><span>Subtotal</span><span>$<span id="subtotal">0.00</span></span></div>
  <div><span>Sales Tax (6%)</span><span>$<span id="tax">0.00</span></span></div>
  <div><span>Discount</span><span>$0.00</span></div>
  <div><span>Keg Deposit</span><span>$<span id="keg">0.00</span></span></div>
  <div><strong>Total</strong><strong>$<span id="grand">0.00</span></strong></div>
</div>

</section>

<!-- ACTIONS -->
<section class="actions">
  <button onclick="savePDF()">Save Invoice</button>
  <button onclick="printPDF()">Print Invoice</button>
  <button onclick="emailInvoice()">Send Invoice via Email</button>
</section>

<script>
const { jsPDF } = window.jspdf;

const invoice = "INV-" + Math.floor(Math.random()*900000);
invoiceNumber.value = invoice;
invoiceDate.textContent = new Date().toLocaleDateString();
JsBarcode("#barcode", invoice, { displayValue:false });

/* Quantity controls */
function updateQty(sel){
  const box = sel.closest("tr").querySelector(".quantity-inputs");
  box.innerHTML="";
  [...sel.selectedOptions].forEach(o=>{
    box.insertAdjacentHTML("beforeend",
      `<div>${o.textContent}: <input type="number" value="1" onchange="recalc()"></div>`
    );
  });
  recalc();
}

/* Add row */
function addRow(){
  document.querySelector("#items tbody")
    .insertAdjacentHTML("beforeend",
      document.querySelector("#items tbody tr").outerHTML);
}

/* Calculations (LOCKED RULES) */
function recalc(){
  let subtotal=0, kegDeposit=0;

  document.querySelectorAll("#items tbody tr").forEach(r=>{
    const price = +r.querySelector(".price").value || 0;
    let rowTotal=0;

    const types = [...r.querySelectorAll(".type option:checked")];
    const qtys = r.querySelectorAll(".quantity-inputs input");

    types.forEach((t,i)=>{
      const q = +qtys[i]?.value || 0;
      rowTotal += q * price;

      if (t.textContent.includes("Keg")) kegDeposit += 30;
    });

    r.querySelector(".line-total").textContent =
      "$" + rowTotal.toFixed(2);

    subtotal += rowTotal;
  });

  const tax = subtotal * 0.06;
  const total = subtotal + tax + kegDeposit;

  subtotal.textContent = subtotal.toFixed(2);
  tax.textContent = tax.toFixed(2);
  keg.textContent = kegDeposit.toFixed(2);
  grand.textContent = total.toFixed(2);
}

/* PDF */
function buildPDF(){
  const doc=new jsPDF();

  doc.addImage(
    document.querySelector(".logo"),
    "JPEG",15,10,30,30
  );

  doc.text("Suburban Brewing Company",50,15);
  doc.text(`Invoice #: ${invoice}`,150,15);
  doc.text(`Date: ${invoiceDate.textContent}`,150,22);

  const bc=document.createElement("canvas");
  JsBarcode(bc,invoice,{displayValue:false});
  doc.addImage(bc,"PNG",150,32,45,14);

  const rows=[];
  document.querySelectorAll("#items tbody tr").forEach(r=>{
    const name=r.querySelector(".product").value;
    const price=r.querySelector(".price").value;
    const qtys=r.querySelectorAll(".quantity-inputs input");
    const types=r.querySelectorAll(".type option:checked");

    types.forEach((t,i)=>{
      rows.push([
        name,
        t.textContent,
        qtys[i]?.value||0,
        "$"+price,
        r.querySelector(".line-total").textContent
      ]);
    });
  });

  doc.autoTable({
    startY:55,
    head:[["Product","Type","Qty","Price","Total"]],
    body:rows
  });

  let y=doc.lastAutoTable.finalY+10;
  doc.text(`Subtotal: $${subtotal.textContent}`,150,y);
  doc.text(`Tax: $${tax.textContent}`,150,y+6);
  doc.text(`Keg Deposit: $${keg.textContent}`,150,y+12);
  doc.text(`Total: $${grand.textContent}`,150,y+18);

  doc.text(
    "Make checks payable to Suburban Brewing Company.",
    15,y+35
  );

  return doc;
}

function savePDF(){ buildPDF().save(invoice+".pdf"); }
function printPDF(){
  const p=buildPDF();
  p.autoPrint();
  window.open(p.output("bloburl"));
}

/* Email (HTML-only) */
function emailInvoice(){
  const subject = `Invoice ${invoice}`;
  const body =
    `Invoice Total: $${grand.textContent}%0D%0A` +
    `Thank you for your business.`;
  window.location.href =
    `mailto:?subject=${subject}&body=${body}`;
}
</script>

</body>
</html>
