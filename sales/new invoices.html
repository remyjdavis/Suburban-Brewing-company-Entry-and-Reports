<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
/* unchanged */
</style>
</head>

<body>
<div class="container">
<!-- unchanged HTML -->
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbys580shBiRLtAW0jAYFoinwKJrycSJQyW8qy95nvLr7dxqOGtzI3e_h9QQn8-ULTT3/exec";
const SALES_TAX_RATE = 0.06;
const KEG_DEPOSIT = 30;
const KEG_TYPES = ["1/6 Keg","1/2 Keg"];

let customerListData = [];
let productListData = [];

/* ===================== ADDITION ===================== */
/* Track selected customer object (NON-DESTRUCTIVE) */
let selectedCustomer = null;
/* =================================================== */

document.getElementById("invoiceDate").innerText = new Date().toLocaleDateString();

/* ===================== ADDITION ===================== */
/* FIX: Missing barcode function */
function refreshBarcode(){
  if(!window.JsBarcode) return;
  const canvas = document.getElementById("barcodeCanvas");
  if(!canvas) return;
  JsBarcode(canvas, document.getElementById("invoiceNumber").value || "", {
    displayValue:false
  });
}
/* =================================================== */

refreshBarcode();

/* ================= LOAD FROM BACKEND ================= */

fetch(API + "?action=getCustomers")
  .then(res => res.json())
  .then(data => {
    customerListData = data;
    customerList.innerHTML = "";
    data.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.name;
      customerList.append(opt);
    });
  });

fetch(API + "?action=getProducts")
  .then(res => res.json())
  .then(data => {
    productListData = data.map(p => ({ product: p.product, type: p.type, price: p.price }));
  });

/* ================= CUSTOMER HANDLING ================= */

function filterCustomers(val) {
  customerName.setAttribute("list", "customerList");
}

function checkNewCustomer(v){
  const found = customerListData.find(c => c.name === v);
  if(found){
    selectedCustomer = found;   // <-- ADDITION
  } else if(v){
    mcName.value = v;
    customerModal.style.display="flex";
  }
}

function confirmCustomer(){
  const name = mcName.value.trim();
  const address = mcAddress.value.trim();
  const type = mcType.value;
  const payment = mcPayment.value;

  fetch(API + "?action=saveCustomer&name=" + encodeURIComponent(name) +
    "&address=" + encodeURIComponent(address) +
    "&type=" + encodeURIComponent(type) +
    "&payment=" + encodeURIComponent(payment))
    .then(() => {
      const newCustomer = { name, address, type, payment };
      customerListData.push(newCustomer);
      selectedCustomer = newCustomer;   // <-- ADDITION
      const opt = document.createElement("option");
      opt.value = name;
      customerList.append(opt);
      customerName.value = name;
      closeCustomer();
    });
}

function closeCustomer(){ customerModal.style.display="none"; }

/* ================= PRODUCT HANDLING ================= */
/* unchanged */

/* ================= ITEMS + CALCULATION ================= */

function calc(){
  let subtotal=0, cases=0, kegs=0;

  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
    const linePrice=+r.children[3].firstChild.value;
    let qty=0;

    r.children[2].querySelectorAll("input").forEach(i=>{
      qty+=+i.value;
      if(i.dataset.type==="Case") cases+=+i.value;
      if(i.dataset.type.includes("Keg")) kegs+=+i.value;
    });

    const line=qty*linePrice;
    r.children[4].innerText="$"+line.toFixed(2);
    subtotal+=line;
  });

  const discount = cases >= 10 ? subtotal*0.10 : 0;

  /* ===================== ADDITION ===================== */
  /* FIX: Sales tax ONLY for Restaurants */
  const tax = selectedCustomer?.type === "Restaurant"
    ? subtotal * SALES_TAX_RATE
    : 0;
  /* =================================================== */

  const deposit = kegs * KEG_DEPOSIT;

  document.getElementById("sub").innerText="$"+subtotal.toFixed(2);
  document.getElementById("disc").innerText="$"+discount.toFixed(2);
  document.getElementById("tax").innerText="$"+tax.toFixed(2);
  document.getElementById("keg").innerText="$"+deposit.toFixed(2);
  document.getElementById("total").innerText="$"+(subtotal-discount+tax+deposit).toFixed(2);
}

/* ================= PDF / SAVE / EMAIL ================= */
/* unchanged placeholders */

</script>
</body>
</html>
