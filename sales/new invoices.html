<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header {
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:20px;
  padding:16px;
  background:#fff;
  border-bottom:1px solid #ccc;
}
.logo { height:50px; }
section { padding:20px; }
.card {
  background:#fff;
  border-radius:8px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.hidden { display:none; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#1abc9c; color:#fff; }
input, select { width:100%; padding:6px; }
.quantity-inputs div { margin-bottom:4px; }
.totals { max-width:420px; margin-top:20px; }
.totals div { display:flex; justify-content:space-between; margin-bottom:6px; }
.actions button { padding:10px 16px; margin-right:10px; cursor:pointer; }
.footer-note { margin-top:16px; font-weight:bold; }
.small-btn { margin-top:6px; padding:6px 12px; }
</style>
</head>

<body>

<header>
  <img src="../sales/background.jpg" class="logo">
  <div>
    <strong>Suburban Brewing Company</strong><br>
    3041 Horseshoe Pike Suite 120 &amp; 130<br>
    Honey Brook, PA 19344<br>
    Sales Rep: Remy Davis | 908-642-1019<br>
    Remyjdavis90@gmail.com
  </div>
  <div style="text-align:right">
    <label>Invoice #</label>
    <input id="invoiceNumber" oninput="updateBarcode()">
    <div id="invoiceDate"></div>
    <svg id="barcode" style="margin-top:6px"></svg>
  </div>
</header>

<section>

<!-- CUSTOMER SEARCH -->
<div class="card">
  <strong>Customer</strong>
  <input id="customerSearch" placeholder="Start typing customer name" onblur="checkCustomer()">
  <div id="customerSummary"></div>
</div>

<!-- NEW CUSTOMER CARD -->
<div class="card hidden" id="customerCard">
  <strong>New Customer</strong>
  <input id="newCustomerName" placeholder="Customer Name">
  <input id="newCustomerAddress" placeholder="Street Address">
  <input id="newCustomerCity" placeholder="City, State ZIP">
  <button class="small-btn" onclick="saveCustomer()">Save Customer</button>
</div>

<!-- NEW PRODUCT CARD -->
<div class="card hidden" id="productCard">
  <strong>New Product</strong>
  <input id="newProductName" placeholder="Product Name">
  <button class="small-btn" onclick="saveProduct()">Save Product</button>
</div>

<!-- INVOICE ITEMS -->
<div class="card">
<table id="items">
<thead>
<tr>
<th>Product Name</th>
<th>Product Type</th>
<th>Quantity</th>
<th>Unit Price</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<input list="productList" onblur="checkProduct(this)">
</td>
<td>
<select multiple onchange="updateQty(this)">
<option>Case</option>
<option>Bottle</option>
<option>1/6 Keg</option>
<option>1/2 Keg</option>
</select>
</td>
<td><div class="quantity-inputs"></div></td>
<td><input type="number" value="0" onchange="recalc()"></td>
<td class="line-total">$0.00</td>
</tr>
</tbody>
</table>

<button class="small-btn" onclick="addRow()">Add Item</button>

<datalist id="productList"></datalist>

<div class="totals">
<div><span>Subtotal</span><span>$<span id="subtotal">0.00</span></span></div>
<div><span>Sales Tax</span><span>$<span id="tax">0.00</span></span></div>
<div><span>Discount</span><span>$0.00</span></div>
<div><span>Keg Deposit</span><span>$<span id="keg">0.00</span></span></div>
<div><strong>Total</strong><strong>$<span id="grand">0.00</span></strong></div>
</div>

<div class="footer-note" id="paymentNote"></div>
</div>

<div class="card actions">
<button onclick="savePDF()">Save</button>
<button onclick="printPDF()">Print</button>
<button onclick="emailInvoice()">Email</button>
</div>

</section>

<script>
const { jsPDF } = window.jspdf;

/* ================= MEMORY ================= */
let customers = [
  { name: "Acme Bar", address: "123 Main St, Honey Brook PA" }
];
let products = ["Beer A", "Beer B", "Beer C"];
let activeCustomer = null;
let isFintech = false;
let customerType = "Restaurant";

/* ================= INIT ================= */
invoiceDate.textContent = new Date().toLocaleDateString();
invoiceNumber.value = "INV-" + Math.floor(Math.random() * 900000);
populateProducts();
updateBarcode();

function normalize(v){ return v.trim().toLowerCase(); }

/* ================= CUSTOMER ================= */
function checkCustomer(){
  const val = customerSearch.value.trim();
  if(!val) return;

  const found = customers.find(c => normalize(c.name) === normalize(val));
  if(found){
    activeCustomer = found;
    customerSummary.innerHTML = `<strong>${found.name}</strong><br>${found.address}`;
  } else {
    if(confirm("Customer not found. Create new?")){
      customerCard.classList.remove("hidden");
      newCustomerName.value = val;
    }
  }
}

function saveCustomer(){
  activeCustomer = {
    name: newCustomerName.value.trim(),
    address: `${newCustomerAddress.value.trim()}, ${newCustomerCity.value.trim()}`
  };
  customers.push(activeCustomer);

  isFintech = confirm("Is this a FINTECH customer?");
  customerType = confirm("Is this a RESTAURANT?") ? "Restaurant" : "Wholesaler";

  customerSummary.innerHTML = `
    <strong>${activeCustomer.name}</strong><br>
    ${activeCustomer.address}<br>${customerType}
  `;

  paymentNote.textContent = isFintech
    ? "Paid through Fintech"
    : "Make checks payable to Suburban Brewing Company";

  customerCard.classList.add("hidden");
  recalc();
}

/* ================= PRODUCTS ================= */
function populateProducts(){
  productList.innerHTML = "";
  products.forEach(p =>
    productList.insertAdjacentHTML("beforeend", `<option value="${p}">`)
  );
}

function checkProduct(input){
  const val = input.value.trim();
  if(!val) return;
  if(!products.some(p => normalize(p) === normalize(val))){
    if(confirm("Product not found. Create new?")){
      productCard.classList.remove("hidden");
      newProductName.value = val;
    }
  }
}

function saveProduct(){
  products.push(newProductName.value.trim());
  populateProducts();
  productCard.classList.add("hidden");
}

/* ================= ROWS ================= */
function addRow(){
  const r = items.tBodies[0].rows[0].cloneNode(true);
  r.querySelector(".quantity-inputs").innerHTML = "";
  r.querySelector(".line-total").textContent = "$0.00";
  items.tBodies[0].appendChild(r);
}

/* ================= QUANTITY ================= */
function updateQty(sel){
  const box = sel.closest("tr").querySelector(".quantity-inputs");
  box.innerHTML = "";
  [...sel.selectedOptions].forEach(o=>{
    box.insertAdjacentHTML("beforeend",
      `${o.textContent}: <input type="number" value="1" onchange="recalc()">`
    );
  });
  recalc();
}

/* ================= CALC ================= */
function recalc(){
  let sub = 0, keg = 0;

  document.querySelectorAll("#items tbody tr").forEach(r=>{
    let row = 0;
    const price = +r.cells[3].querySelector("input").value || 0;
    const types = r.cells[1].querySelectorAll("option:checked");
    const qtys = r.cells[2].querySelectorAll("input");

    types.forEach((t,i)=>{
      row += price * (+qtys[i].value || 0);
      if(t.textContent.includes("Keg")) keg += 30;
    });

    r.querySelector(".line-total").textContent = "$" + row.toFixed(2);
    sub += row;
  });

  const tax = customerType === "Restaurant" ? sub * 0.06 : 0;
  subtotal.textContent = sub.toFixed(2);
  tax.textContent = tax.toFixed(2);
  keg.textContent = keg.toFixed(2);
  grand.textContent = (sub + tax + keg).toFixed(2);
}

/* ================= BARCODE ================= */
function updateBarcode(){
  JsBarcode("#barcode", invoiceNumber.value, { displayValue:false });
}

/* ================= PDF ================= */
function buildPDF(){
  const d = new jsPDF();
  d.text("Suburban Brewing Company", 14, 14);
  d.text(`Invoice ${invoiceNumber.value}`, 150, 14);
  d.text(`Date: ${invoiceDate.textContent}`, 150, 20);

  if(activeCustomer){
    d.text(`Bill To: ${activeCustomer.name}`, 14, 26);
    d.text(activeCustomer.address, 14, 32);
  }

  const c = document.createElement("canvas");
  JsBarcode(c, invoiceNumber.value, { displayValue:false });
  d.addImage(c, "PNG", 150, 26, 40, 12);

  const rows = [];
  document.querySelectorAll("#items tbody tr").forEach(r=>{
    const name = r.cells[0].querySelector("input").value;
    const price = r.cells[3].querySelector("input").value;
    const types = r.cells[1].querySelectorAll("option:checked");
    const qtys = r.cells[2].querySelectorAll("input");

    types.forEach((t,i)=>{
      rows.push([name, t.textContent, qtys[i].value, "$"+price, r.querySelector(".line-total").textContent]);
    });
  });

  d.autoTable({ startY: 42, head:[["Product","Type","Qty","Price","Total"]], body: rows });
  d.text(paymentNote.textContent, 14, d.lastAutoTable.finalY + 10);
  return d;
}

function savePDF(){ buildPDF().save(invoiceNumber.value + ".pdf"); }
function printPDF(){ const d=buildPDF(); d.autoPrint(); window.open(d.output("bloburl")); }
function emailInvoice(){
  location.href=`mailto:?subject=Invoice ${invoiceNumber.value}&body=Total $${grand.textContent}`;
}
</script>

</body>
</html>
